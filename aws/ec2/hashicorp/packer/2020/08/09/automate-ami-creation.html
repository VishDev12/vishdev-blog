<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Automating AWS AMI Creation | fastpages</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Automating AWS AMI Creation" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An easy to use blogging platform with support for Jupyter Notebooks." />
<meta property="og:description" content="An easy to use blogging platform with support for Jupyter Notebooks." />
<link rel="canonical" href="https://krvdev.com/vishdev-blog/aws/ec2/hashicorp/packer/2020/08/09/automate-ami-creation.html" />
<meta property="og:url" content="https://krvdev.com/vishdev-blog/aws/ec2/hashicorp/packer/2020/08/09/automate-ami-creation.html" />
<meta property="og:site_name" content="fastpages" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-09T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"An easy to use blogging platform with support for Jupyter Notebooks.","url":"https://krvdev.com/vishdev-blog/aws/ec2/hashicorp/packer/2020/08/09/automate-ami-creation.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://krvdev.com/vishdev-blog/aws/ec2/hashicorp/packer/2020/08/09/automate-ami-creation.html"},"headline":"Automating AWS AMI Creation","dateModified":"2020-08-09T00:00:00-05:00","datePublished":"2020-08-09T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/vishdev-blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://krvdev.com/vishdev-blog/feed.xml" title="fastpages" /><link rel="shortcut icon" type="image/x-icon" href="/vishdev-blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/vishdev-blog/">fastpages</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/vishdev-blog/about/">About Me</a><a class="page-link" href="/vishdev-blog/search/">Search</a><a class="page-link" href="/vishdev-blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Automating AWS AMI Creation</h1><p class="page-description">  </p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-08-09T00:00:00-05:00" itemprop="datePublished">
        Aug 9, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      5 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/vishdev-blog/categories/#AWS">AWS</a>
        &nbsp;
      
        <a class="category-tags-link" href="/vishdev-blog/categories/#EC2">EC2</a>
        &nbsp;
      
        <a class="category-tags-link" href="/vishdev-blog/categories/#HashiCorp">HashiCorp</a>
        &nbsp;
      
        <a class="category-tags-link" href="/vishdev-blog/categories/#Packer">Packer</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This article briefly delves into Hashicorp <a href="https://www.packer.io/">Packer</a> and what it can do for your AMI creation workflow.</p>

<p>Setting up an AMI is a well-defined process that usually follows these steps:</p>

<ol>
  <li>
    <p>Launch an instance from an existing AMI, private or public.</p>
  </li>
  <li>
    <p>SSH into the instance.</p>
  </li>
  <li>
    <p>Execute a series of commands to configure it.</p>
  </li>
  <li>
    <p>Stop the instance.</p>
  </li>
  <li>
    <p>Create an AMI from the instance.</p>
  </li>
  <li>
    <p>Terminate the instance.</p>
  </li>
  <li>
    <p>If you need the AMI in a different region or account, do a manual copy operation or explicitly grant rights to a different account.</p>
  </li>
  <li>
    <p>Repeat steps 1-7 whenever you need a change in the AMI.</p>
  </li>
</ol>

<p>Since AMI creation is such an involved and lengthy process, we might sometimes prefer to have an initialization script that runs every time an instance is launched with the AMI and have the script configure the instance with the latest updates to suit our needs. This renders the launched instance unusable for a period of time until the configuration process is complete and might even contribute to higher costs if the workloads are short-lived.</p>

<p>Justifiably, these costs might be more than acceptable considering the alternative, which would be having to follow the lengthy workflow laid out above every time you need your AMI updated.</p>

<p>But what if we could automate this process and treat AMI creation like a git push or a simple configuration change?</p>

<p><strong>Enter Packer.</strong></p>

<p>Packer automates every step in the AMI creation workflow using a JSON template that you define, which means that your workflow for setting up an AMI will now look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. Create a JSON template.

2. packer validate template.json

3. packer build template.json
</code></pre></div></div>

<p>When you need to update the AMI, modify your template to make the changes you need, and run steps 2 and 3.</p>

<p>The Packer documentation is comprehensive and can be found <a href="https://www.packer.io/docs">here</a> and a tutorial can be found <a href="https://learn.hashicorp.com/tutorials/packer/getting-started-build-image">here</a>. But in order to get a quick intuition of what Packer can do, let’s explore a simple example.</p>

<h2 id="example-use-case">Example Use Case</h2>

<p>You need to build an AMI with the following properties:</p>

<ul>
  <li>You have a series of existing AMIs that all start with the prefix <code class="language-plaintext highlighter-rouge">sample_ami_v_</code>. You will also be following this naming guideline for your new AMI.
    <blockquote>
      <p>Versioning the AMI names with predictable prefixes allows you to filter them programmatically.</p>
    </blockquote>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">redis-server</code> apt package needs to be added to the AMI.</p>
  </li>
  <li>
    <p>The AMI needs to be available in the <code class="language-plaintext highlighter-rouge">us-east-1</code> region primarily, and additionally in the <code class="language-plaintext highlighter-rouge">ap-southeast-1</code> and <code class="language-plaintext highlighter-rouge">ap-south-1</code> regions.</p>
  </li>
  <li>The AMIs should be accessible from a different AWS account with the account ID: <code class="language-plaintext highlighter-rouge">123456789123</code>.</li>
</ul>

<h3 id="json-template">JSON Template</h3>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"variables"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aws_access_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nl">"aws_secret_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"builders"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"amazon-ebs"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"access_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"secret_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-east-1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"source_ami_filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"filters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sample_ami_v_*"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"owners"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"987654321987"</span><span class="p">],</span><span class="w">
        </span><span class="nl">"most_recent"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"instance_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t2.medium"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ssh_username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ubuntu"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ami_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sample_ami_v_"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"run_tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ami_creator"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"ami_regions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"ap-southeast-1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ap-south-1"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"ami_users"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"123456789123"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"provisioners"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"shell"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inline_shebang"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/bin/bash -e"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inline"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"sudo apt install redis-server"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="breakdown">Breakdown</h3>

<ul>
  <li>Packer uses the AWS access key and the secret key to access and provision AWS resources.
    <ul>
      <li>Set environment variables on the command line and define them inside <code class="language-plaintext highlighter-rouge">variables</code>; they can be now be accessed in your template as user variables.</li>
    </ul>
  </li>
  <li>After determining an appropriate AMI by using <code class="language-plaintext highlighter-rouge">builders</code> -&gt; <code class="language-plaintext highlighter-rouge">source_ami_filter</code>, an instance is launched in “us-east-1” (<code class="language-plaintext highlighter-rouge">builders</code> -&gt; <code class="language-plaintext highlighter-rouge">region</code>).
    <ul>
      <li>A temporary security group and key pair are created.</li>
      <li>The security group allows access to port 22 (SSH).</li>
      <li>The tags specified under <code class="language-plaintext highlighter-rouge">builders</code> -&gt; <code class="language-plaintext highlighter-rouge">run_tags</code> are added to the launched instance.</li>
    </ul>
  </li>
  <li>Packer connects to the instance using SSH and executes the commands defined under <code class="language-plaintext highlighter-rouge">provisioners</code> -&gt; <code class="language-plaintext highlighter-rouge">inline</code>.
    <ul>
      <li>The output of these commands will be displayed on your console.</li>
      <li>The <code class="language-plaintext highlighter-rouge">-e</code> flag is used when defining <code class="language-plaintext highlighter-rouge">provisioners</code> -&gt; <code class="language-plaintext highlighter-rouge">inline_shebang</code> to ensure that errors caused by the commands will trigger the failure of the build process, which prevents your AMIs from being silently built with something that’s not according to your specifications.</li>
    </ul>
  </li>
  <li>Once that’s done, the instance is stopped, and an AMI (named <code class="language-plaintext highlighter-rouge">builders</code> -&gt; <code class="language-plaintext highlighter-rouge">ami_name</code>) is created using the stopped instance.
    <ul>
      <li>This might take a few minutes.</li>
    </ul>
  </li>
  <li>
    <p>The newly created AMI is then copied over to the regions specified under <code class="language-plaintext highlighter-rouge">builders</code> -&gt; <code class="language-plaintext highlighter-rouge">ami_regions</code>.</p>
  </li>
  <li>Once the copies are done, permissions are granted to these AMIs for the users specified under <code class="language-plaintext highlighter-rouge">builders</code> -&gt; <code class="language-plaintext highlighter-rouge">ami_users</code>.
    <ul>
      <li>So in this case, we will end up with three AMIs across three different regions and each of those AMIs will be available to two AWS accounts – the original user and user “123456789123”.</li>
    </ul>
  </li>
  <li>The final step is clean-up.
    <ul>
      <li>The launched instance is terminated.</li>
      <li>The temporary security group and key pair are deleted.</li>
    </ul>
  </li>
</ul>

<h2 id="summary">Summary</h2>

<p>Thus, with a bit of initial setup, Packer automates the entire AMI build process. Here are some take-aways and points to note:</p>

<ul>
  <li>
    <p>The configuration of the launched instance can be as simple as installing a single package, as in the example above, or as complex as running an Ansible Playbook. You can find a list of provisioners that you can use to configure your instance <a href="https://www.packer.io/docs/provisioners/ansible">here</a>.</p>
  </li>
  <li>Commit your packer templates to your code repository to help you version your changes.
    <ul>
      <li>If possible, have a folder set aside for Packer templates and have one copy for each version of the template there (v1, v2, v3, etc) to give yourself a clear overview of the changes being added to your AMI over time.</li>
    </ul>
  </li>
  <li>
    <p>Use <code class="language-plaintext highlighter-rouge">builders</code> -&gt; <code class="language-plaintext highlighter-rouge">ami_description</code> to describe the changes you’re making to the AMI.</p>
  </li>
  <li>
    <p>Packer only creates your AMIs and in no way manages them. So it’s important to keep this in mind when setting up an automated pipeline using Packer, especially if you’re specifying availability for multiple regions. Over time, these AMIs might invisibly add up in the background, contributing to higher costs.</p>
  </li>
  <li>You can have multiple builders in a single template, which allows you to define different AMIs in a single file. You can use this feature to create AMIs for multiple platforms at the same time. An example can be found <a href="https://learn.hashicorp.com/tutorials/packer/getting-started-parallel-builds">here</a>.</li>
</ul>

  </div><a class="u-url" href="/vishdev-blog/aws/ec2/hashicorp/packer/2020/08/09/automate-ami-creation.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/vishdev-blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/vishdev-blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/vishdev-blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>An easy to use blogging platform with support for Jupyter Notebooks.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/fastai" title="fastai"><svg class="svg-icon grey"><use xlink:href="/vishdev-blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/fastdotai" title="fastdotai"><svg class="svg-icon grey"><use xlink:href="/vishdev-blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
